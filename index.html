<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer P2P - PC Controls</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui { 
            position: absolute; top: 20px; left: 20px; 
            background: rgba(0, 0, 0, 0.7); padding: 15px; 
            border-radius: 8px; color: white; z-index: 10;
            border: 1px solid #444;
        }
        canvas { display: block; }
        input { padding: 5px; border-radius: 4px; border: none; }
        button { cursor: pointer; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px; }
        b { color: #00ffcc; }
    </style>
</head>
<body>

<div id="ui">
    <div>Tu ID: <b id="my-id">Generando...</b></div>
    <div style="margin-top: 10px;">
        <input type="text" id="peer-id-input" placeholder="ID de tu amigo">
        <button onclick="connectToPeer()">Conectar</button>
    </div>
    <p id="status" style="font-size: 0.8em; color: #aaa;">Usa las FLECHAS o WASD para moverte</p>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- Configuración de Red (P2P) ---
    const peer = new Peer();
    let conn;
    let players = {}; 
    let myId;

    peer.on('open', (id) => {
        myId = id;
        document.getElementById('my-id').innerText = id;
        // Creamos nuestro jugador local
        players[id] = { x: canvas.width/2, y: canvas.height/2, color: '#00ffcc', name: 'Yo' };
    });

    peer.on('connection', (connection) => {
        setupConnection(connection);
    });

    function connectToPeer() {
        const peerId = document.getElementById('peer-id-input').value;
        setupConnection(peer.connect(peerId));
    }

    function setupConnection(connection) {
        conn = connection;
        conn.on('open', () => {
            document.getElementById('status').innerText = "¡Conectado con éxito!";
            document.getElementById('status').style.color = "#00ff00";
            
            // Enviamos nuestra posición 60 veces por segundo
            setInterval(() => {
                if(conn.open) {
                    conn.send({ id: myId, x: players[myId].x, y: players[myId].y });
                }
            }, 1000/60);
        });

        conn.on('data', (data) => {
            // Actualizamos (o creamos) al otro jugador con los datos recibidos
            players[data.id] = { x: data.x, y: data.y, color: '#ff4444', name: 'Amigo' };
        });
    }

    // --- Control por Teclado ---
    const keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function handleMovement() {
        if (!players[myId]) return;

        const speed = 5;
        // Flechas o WASD
        if (keys['ArrowUp'] || keys['KeyW']) players[myId].y -= speed;
        if (keys['ArrowDown'] || keys['KeyS']) players[myId].y += speed;
        if (keys['ArrowLeft'] || keys['KeyA']) players[myId].x -= speed;
        if (keys['ArrowRight'] || keys['KeyD']) players[myId].x += speed;

        // Limites de pantalla básicos
        players[myId].x = Math.max(0, Math.min(canvas.width - 30, players[myId].x));
        players[myId].y = Math.max(0, Math.min(canvas.height - 30, players[myId].y));
    }

    // --- Ciclo de Renderizado ---
    function draw() {
        handleMovement();
        
        // Fondo
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Dibujar cuadrícula de fondo (opcional, para referencia)
        ctx.strokeStyle = '#333';
        for(let i=0; i<canvas.width; i+=50) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke();
        }
        for(let i=0; i<canvas.height; i+=50) {
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); ctx.stroke();
        }

        // Dibujar jugadores
        for (let id in players) {
            const p = players[id];
            
            // Cuerpo
            ctx.fillStyle = p.color;
            ctx.shadowBlur = 15;
            ctx.shadowColor = p.color;
            ctx.fillRect(p.x, p.y, 30, 30);
            
            // Nombre o etiqueta
            ctx.shadowBlur = 0;
            ctx.fillStyle = "white";
            ctx.font = "12px Arial";
            ctx.fillText(p.name, p.x, p.y - 10);
        }

        requestAnimationFrame(draw);
    }

    draw();

    // Ajustar canvas si se cambia el tamaño de ventana
    window.onresize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    };
</script>
</body>
</html>
